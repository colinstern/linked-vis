<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/dc.css" />
  <script src="https://dc-js.github.io/dc.js/js/d3.js"></script>
  <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
  <script src="https://dc-js.github.io/dc.js/js/dc.js"></script>
  <script src="https://rawgit.com/crossfilter/reductio/master/reductio.js"></script>
  <script src="https://npmcdn.com/universe@latest/universe.js"></script>
  <script type="text/javascript" src="colorbrewer.js"></script>
  <style>
  </style>
  <title>YOLO</title>
</head>

<body>

  <div class="row">
    <div id="monthly-bubble-chart" class="dc-chart">
        <strong>Monthly Performance</strong> (radius: engaged users, color: lifetime total post impressions gain)
        <a class="reset" href="javascript:yearlyBubbleChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
  <div id="day-of-week-chart">
       <strong>Day of Week</strong>
       <a class="reset" href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
   </div>
</div>

<div class="row">
    <div id="monthly-move-chart">
        <strong>Monthly Like Chart</strong>
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:moveChart.filterAll();volumeChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

  <script>
  'use strict';

  /* jshint globalstrict: true */
  /* global dc,d3,crossfilter,colorbrewer */

  /* Create chart objects */
  /* scatterplot */
  var yearlyBubbleChart = dc.bubbleChart('#monthly-bubble-chart');
  /* line chart */
  var moveChart = dc.lineChart('#monthly-move-chart');
  var volumeChart = dc.barChart('#monthly-volume-chart');
  /* histogram */
  var dayOfWeekChart = dc.rowChart('#day-of-week-chart');
  /* heatmap */
  //var heatMap = dc.heatMap('#heatmap');


  d3.csv('dataset_Facebook-table.csv', function(data) {
    var numberFormat = d3.format('r');

    data.forEach(function (d) {
      d.PageTotalLikes = +d.PageTotalLikes;
      /* TODO Get month name */
      d.PostMonth = +d.PostMonth;
      /* TODO Get weekday name */
      d.PostWeekday = +d.PostWeekday;
      d.PostHour = +d.PostHour;
      d.LifetimePostTotalImpressions = + d.LifetimePostTotalImpressions;
      d.LifetimeEngagedUsers = +d.LifetimeEngagedUsers;
      d.LifetimePostConsumptions = +d.LifetimePostConsumptions;
      d.LifetimePostImpressionsbypeoplewhohavelikedyourPage = +d.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
    });


    var fb = crossfilter(data);
    var all = fb.groupAll();

    var monthlyDimension = fb.dimension(function (d) {
      return d.PostMonth;
    });

    var postImpressionsLikePageAvgByMonthGroup = monthlyDimension.group().reduce(
    function (p, v) {
        ++p.days;
        p.total += v.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
        p.avg = Math.round(p.total / p.days);
        return p;
    },
    function (p, v) {
        --p.days;
        p.total -= v.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
        p.avg = Math.round(p.total / p.days);
        return p;
    },
    function () {
        return {days: 0, total: 0, avg: 0};
    }
);

    var likeAvgByMonthGroup = monthlyDimension.group().reduce(
    function (p, v) {
        ++p.days;
        p.total += v.PageTotalLikes;
        p.avg = Math.round(p.total / p.days);
        return p;
    },
    function (p, v) {
        --p.days;
        p.total -= v.PageTotalLikes;
        p.avg = p.days ? Math.round(p.total / p.days) : 0;
        return p;
    },
    function () {
        return {days: 0, total: 0, avg: 0};
    }
);


    var monthlyPerformanceGroup = monthlyDimension.group().reduce(
    /* callback for when data is added to the current filter results */
    function (p, v) {
        ++p.count;
        p.impressionsGain += v.LifetimePostTotalImpressions;
        p.usersGain += v.LifetimeEngagedUsers;
        p.avgImpressions = p.impressionsGain / p.count;
        p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
        return p;
    },
    /* callback for when data is removed from the current filter results */
    function (p, v) {
        --p.count;
        p.impressionsGain -= v.LifetimePostTotalImpressions;
        p.usersGain -= v.LifetimeEngagedUsers;
        p.avgImpressions = p.impressionsGain / p.count;
        p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
    },
    /* initialize p */
    function () {
        return {
            count: 0,
            impressionsGain: 0,
            usersGain: 0,
            avgImpressions: 0,
            percentageGain: 0,
        };
    }
);

var monthlyLikeGroup = monthlyDimension.group().reduceSum(function (d) {
  return d.PageTotalLikes;
});

var dayOfWeek = fb.dimension(function (d) {
    var day = d.PostWeekday;
    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    return day + '.' + name[day - 1];
});
var dayOfWeekGroup = dayOfWeek.group();

function nameOfMonth (d) {
  var name = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  return name[d - 1];
}

yearlyBubbleChart
    .width(990)
    .height(240)
    .transitionDuration(1500)
    .margins({top: 10, right: 50, bottom: 30, left: 40})
    .dimension(monthlyDimension)
    .group(monthlyPerformanceGroup)
    .colors(colorbrewer.RdYlGn[9])
    .colorDomain([200000, 2300000])

    .colorAccessor(function (d) {
        return d.value.impressionsGain;
    })

    .keyAccessor(function (p) {
        return p.value.impressionsGain;
    })

    .valueAccessor(function (p) {
        return p.value.percentageGain;
    })

    .radiusValueAccessor(function (p) {
        return p.value.usersGain;
    })

    .maxBubbleRelativeSize(0.3)
    .x(d3.scale.linear().domain([0, 250000]))
    .y(d3.scale.linear().domain([0, 60000]))
    .r(d3.scale.linear().domain([0, 500000]))

    .elasticY(true)
    .elasticX(true)

    .yAxisPadding(100)
    .xAxisPadding(500)

    .renderHorizontalGridLines(true)
    .renderVerticalGridLines(true)

    .xAxisLabel('Lifetime Total Post Impressions Gain')
    .yAxisLabel('Gain %')

    .renderLabel(true)
    .label(function (p) {
        return nameOfMonth(p.key);
    })

    .renderTitle(true)
    .title(function (p) {
        return [
            nameOfMonth(p.key),
            'Impressions Gain: ' + numberFormat(p.value.impressionsGain),
            'Impressions Gain in Percentage: ' + numberFormat(p.value.percentageGain) + '%',
            'Total Lifetime Engaged Users: ' + numberFormat(p.value.usersGain)
        ].join('\n');
    })

    .yAxis().tickFormat(function (v) {
        return v + '%';
    });


  dayOfWeekChart
      .width(180)
      .height(180)
      .margins({top: 20, left: 10, right: 10, bottom: 20})
      .group(dayOfWeekGroup)
      .dimension(dayOfWeek)

      .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
      .label(function (d) {
          return d.key.split('.')[1];
      })

      .title(function (d) {
          return d.value;
      })

      .elasticX(true)
      .xAxis().ticks(4);

  moveChart
      .renderArea(true)
      .width(990)
      .height(200)
      .transitionDuration(1000)
      .margins({top: 30, right: 50, bottom: 25, left: 40})
      .dimension(monthlyDimension)
      .mouseZoomable(true)

      .rangeChart(volumeChart)
      .x(d3.scale.linear().domain([1, 12]))
      .y(d3.scale.linear().domain([80000, 160000]))
      .elasticY(false)
      .renderHorizontalGridLines(true)

      .legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
      .brushOn(false)

      .group(likeAvgByMonthGroup, 'Monthly Like Average')
      .valueAccessor(function (d) {
          return d.value.avg;
      })

      .stack(postImpressionsLikePageAvgByMonthGroup, 'Lifetime Post Impressions by people who have liked your Page', function (d) {
          return d.value.avg;
      })

      .title(function (d) {
          var value = d.value.avg ? d.value.avg : d.value;
          if (isNaN(value)) {
              value = 0;
          }
          return nameOfMonth(d.key) + '\n' + numberFormat(value);
      })
      .yAxis().ticks(7);
      moveChart.xAxisLabel


  volumeChart
      .width(990) /* dc.barChart('#monthly-volume-chart', 'chartGroup'); */
      .height(40)
      .margins({top: 0, right: 50, bottom: 20, left: 40})
      .dimension(monthlyDimension)
      .group(postImpressionsLikePageAvgByMonthGroup)
      .centerBar(true)
      .gap(1)
      .x(d3.scale.linear().domain([0, 12]));


    dc.renderAll();

  });


  </script>
</body>
