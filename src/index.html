<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/dc.css" />
  <script src="js/d3.js"></script>
  <script src="js/crossfilter.js"></script>
  <script src="js/dc.js"></script>
  <script src="js/reductio.js"></script>
  <script src="js/universe.js"></script>
  <script type="text/javascript" src="js/colorbrewer.js"></script>
  <style>
  </style>
  <title>Facebook Statistics</title>
</head>

<body>

  <h1>Facebook Performance Metrics</h1>

  <div class="row">
    <div id="monthly-bubble-chart" class="dc-chart">
        <strong>Aggregate Post Performance by Month of Posting</strong> (radius: engaged users, color: lifetime total post impressions gain)
        <a class="reset" href="javascript:yearlyBubbleChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
  <div id="day-of-week-chart">
       <strong>Posts by Day of Week</strong>
       <a class="reset" href="javascript:dayOfWeekChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
   </div>
</div>

<div class="row">
    <div id="monthly-move-chart">
        <strong>Monthly Like Chart</strong>
        <span class="reset" style="display: none;">range: <span class="filter"></span></span>
        <a class="reset" href="javascript:moveChart.filterAll();volumeChart.filterAll();dc.redrawAll();"
           style="display: none;">reset</a>
        <div class="clearfix"></div>
    </div>
</div>

<div class="row">
    <div id="monthly-volume-chart">
    </div>
    <p class="muted pull-right" style="margin-right: 15px;"></p>
</div>

<div class="row">
  <div id="heatmap">
       <strong>Lifetime Total Post Impressions by Post Type and Hour</strong>
       <a class="reset" href="javascript:heatMap.filterAll();dc.redrawAll();" style="display: none;">reset</a>
       <div class="clearfix"></div>
   </div>
</div>

  <script>
  'use strict';

  /* jshint globalstrict: true */
  /* global dc,d3,crossfilter,colorbrewer */

  /* Create chart objects */
  /* scatterplot */
  var yearlyBubbleChart = dc.bubbleChart('#monthly-bubble-chart');
  /* line chart */
  var moveChart = dc.lineChart('#monthly-move-chart');
  var volumeChart = dc.barChart('#monthly-volume-chart');
  /* histogram */
  var dayOfWeekChart = dc.rowChart('#day-of-week-chart');
  /* heatmap */
  var heatMap = dc.heatMap('#heatmap');


  d3.csv('data/dataset_Facebook-table.csv', function(data) {
    var numberFormat = d3.format('r');

    var commaFormat = d3.format('0,000');

    var hourFormat = d3.time.format("%I %p");

    data.forEach(function (d) {
      d.PageTotalLikes = +d.PageTotalLikes;
      /* TODO Get month name */
      d.PostMonth = +d.PostMonth;
      /* TODO Get weekday name */
      d.PostWeekday = +d.PostWeekday;
      d.PostHour = +d.PostHour;
      d.LifetimePostTotalImpressions = + d.LifetimePostTotalImpressions;
      d.LifetimeEngagedUsers = +d.LifetimeEngagedUsers;
      d.LifetimePostConsumptions = +d.LifetimePostConsumptions;
      d.LifetimePostImpressionsbypeoplewhohavelikedyourPage = +d.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
      d.like = +d.like;
    });


    var fb = crossfilter(data);
    var all = fb.groupAll();

    var monthlyDimension = fb.dimension(function (d) {
      return d.PostMonth;
    });

    var postImpressionsAvgByMonthGroup = monthlyDimension.group().reduce(
    function (p, v) {
        //++p.days;
        p.total += v.LifetimeEngagedUsers;
        //p.avg = Math.round(p.total / p.days);
        return p;
    },
    function (p, v) {
        //--p.days;
        p.total -= v.LifetimeEngagedUsers;
        //p.avg = Math.round(p.total / p.days);
        return p;
    },
    function () {
        return {total: 0};
    }
);

    var likeAvgByMonthGroup = monthlyDimension.group().reduce(
    function (p, v) {
        ++p.days;
        p.total += v.PageTotalLikes;
        p.avg = Math.round(p.total / p.days);
        return p;
    },
    function (p, v) {
        --p.days;
        p.total -= v.PageTotalLikes;
        p.avg = p.days ? Math.round(p.total / p.days) : 0;
        return p;
    },
    function () {
        return {days: 0, total: 0, avg: 0};
    }
);


    var monthlyPerformanceGroup = monthlyDimension.group().reduce(
    /* callback for when data is added to the current filter results */
    function (p, v) {
        ++p.count;
        p.impressionsGain += v.LifetimePostTotalImpressions;
        p.usersGain += v.LifetimeEngagedUsers;
        p.likeImpressions += v.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
        // p.avgImpressions = p.impressionsGain / p.count;
        // p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
        return p;
    },
    /* callback for when data is removed from the current filter results */
    function (p, v) {
        --p.count;
        p.impressionsGain -= v.LifetimePostTotalImpressions;
        p.usersGain -= v.LifetimeEngagedUsers;
        p.likeImpressions -= v.LifetimePostImpressionsbypeoplewhohavelikedyourPage;
        // p.avgImpressions = p.impressionsGain / p.count;
        // p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
	return p;
    },
    /* initialize p */
    function () {
        return {
            count: 0,
            impressionsGain: 0,
            usersGain: 0,
            likeImpressions: 0
        };
    }
);

var monthlyLikeGroup = monthlyDimension.group().reduceSum(function (d) {
  return d.PageTotalLikes;
});

var dayOfWeek = fb.dimension(function (d) {
    var day = d.PostWeekday;
    var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    return day + '.' + name[day - 1];
});
var dayOfWeekGroup = dayOfWeek.group();

function nameOfMonth (d) {
  var name = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  return name[d - 1];
}

var typeDimension = fb.dimension(function(d) { return [d.PostHour, d.Type]; });

var hourOfTheWeekdayDimension = fb.dimension(function(d) { return [d.PostHour, d.PostMonth]; });

var percentageGainByHourOfTypeGroup = typeDimension.group().reduce(
/* callback for when data is added to the current filter results */
function (p, v) {
    ++p.count;
    p.impressionsGain += v.LifetimePostTotalImpressions;
    p.usersGain += v.LifetimeEngagedUsers;
    p.avgImpressions = p.impressionsGain / p.count;
    p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
    p.min = p.percentageGain < p.min ? p.percentageGain : p.min;
    p.max = p.percentageGain > p.max ? p.percentageGain : p.max;
    return p;
},
/* callback for when data is removed from the current filter results */
function (p, v) {
    --p.count;
    p.impressionsGain -= v.LifetimePostTotalImpressions;
    p.usersGain -= v.LifetimeEngagedUsers;
    p.avgImpressions = p.impressionsGain / p.count;
    p.percentageGain = p.avgImpressions ? Math.round((p.impressionsGain / p.avgImpressions) * 100) : 0;
    p.min = p.percentageGain < p.min ? p.percentageGain : p.min;
    p.max = p.percentageGain > p.max ? p.percentageGain : p.max;
    return p;
},
/* initialize p */
function () {
    return {
        count: 0,
        impressionsGain: 0,
        usersGain: 0,
        avgImpressions: 0,
        percentageGain: 0,
        min: 10000,
        max: -10000
    };
}
);

var heatColorMapping = d3.scale.linear()
    .domain([100, 100000, 2000000])
    .range(["red", "#e5e5e5", "green"]);

yearlyBubbleChart
    .width(990)
    .height(240)
    .transitionDuration(1500)
    .margins({top: 10, right: 50, bottom: 30, left: 40})
    .dimension(monthlyDimension)
    .group(monthlyPerformanceGroup)
    .colors(colorbrewer.RdYlGn[9])
    .colorDomain([200000, 2300000])

    .colorAccessor(function (d) {
        return d.value.impressionsGain;
    })

    .keyAccessor(function (p) {
        return p.value.impressionsGain;
    })

    .valueAccessor(function (p) {
        return p.value.likeImpressions;
    })

    .radiusValueAccessor(function (p) {
        return p.value.usersGain;
    })

    .maxBubbleRelativeSize(0.3)
    .x(d3.scale.linear().domain([170000, 2400000]))
    .y(d3.scale.linear().domain([1700, 6800]))
    .r(d3.scale.linear().domain([0, 500000]))

    .elasticY(true)
    .elasticX(true)

    .yAxisPadding(100)
    .xAxisPadding(500)

    .renderHorizontalGridLines(true)
    .renderVerticalGridLines(true)

    .xAxisLabel('Lifetime Aggregate Post Impressions')
    .yAxisLabel('Impressions From Likers')

    .renderLabel(true)
    .label(function (p) {
        return nameOfMonth(p.key);
    })

    .renderTitle(true)
    .title(function (p) {
        return [
            nameOfMonth(p.key),
            'Impressions: ' + commaFormat(p.value.impressionsGain),
            'Impressions From Page Likers: ' + commaFormat(p.value.likeImpressions),
            'Total Lifetime Engaged Users: ' + commaFormat(p.value.usersGain)
        ].join('\n');
    })

    .yAxis().tickFormat(function (v) {
        return commaFormat(v);
    });


  dayOfWeekChart
      .width(180)
      .height(180)
      .margins({top: 20, left: 10, right: 10, bottom: 20})
      .group(dayOfWeekGroup)
      .dimension(dayOfWeek)

      .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
      .label(function (d) {
          return d.key.split('.')[1];
      })

      .title(function (d) {
          return d.value;
      })

      .elasticX(true)
      .xAxis().ticks(4);

  moveChart
      .renderArea(true)
      .width(990)
      .height(200)
      .transitionDuration(1000)
      .margins({top: 30, right: 50, bottom: 25, left: 40})
      .dimension(monthlyDimension)
      .mouseZoomable(true)

      .rangeChart(volumeChart)
      .x(d3.scale.linear().domain([1, 12]))
      .y(d3.scale.linear().domain([80000, 190000]))
      .elasticY(true)
      .renderHorizontalGridLines(true)

      .legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
      .brushOn(false)

      .group(likeAvgByMonthGroup, 'Page Likes')
      .valueAccessor(function (d) {
          return d.value.avg;
      })

      .stack(postImpressionsAvgByMonthGroup, 'Engaged Users', function (d) {
          return d.value.total;
      })

      .title(function (d) {
          var value = d.value.avg ? d.value.avg : d.value;
          if (isNaN(value)) {
              value = 0;
          }
          return nameOfMonth(d.key) + '\n' + numberFormat(value);
      })
      .xAxis().tickFormat(function (v) {
          return nameOfMonth(v);
      });
      moveChart.yAxisLabel('')
      .yAxis().ticks(7);


  volumeChart
      .width(990) /* dc.barChart('#monthly-volume-chart', 'chartGroup'); */
      .height(40)
      .margins({top: 0, right: 50, bottom: 20, left: 40})
      .dimension(monthlyDimension)
      .group(postImpressionsAvgByMonthGroup)
      .valueAccessor(function (d) {
          return d.value.total;
      })
      .centerBar(true)
      .gap(1)
      .x(d3.scale.linear().domain([1, 12]))
      .yAxisLabel('')
      .xAxis().tickFormat(function (v) {
          return nameOfMonth(v);
      });
      volumeChart.yAxis().ticks(0);

  heatMap
      .width(12 * 80 + 80)
      .height(27 * 10 + 40)
      .dimension(typeDimension)
      .group(percentageGainByHourOfTypeGroup)
      .keyAccessor(function(d) { return d.key[0]; })
      .valueAccessor(function(d) { return d.key[1]; })
      .colorAccessor(function(d) { return d.value.impressionsGain; })
      .title(function(d) {
        var date = new Date();
        date.setHours(d.key[0],0,0,0);
          return " Hour:   " + hourFormat(date) + "\n" +
                 "Type:   " + d.key[1] + "\n" +
                 "Impressions:   " + commaFormat(d.value.impressionsGain) + "\n";})
      .colors(heatColorMapping);

      heatMap.xBorderRadius(0);
      heatMap.yBorderRadius(0);

    dc.renderAll();

  });


  </script>
</body>
